<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å¿…æ®ºæŠ€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    button {
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
    }
    #generateBtn {
      background-color: #007bff;
      color: white;
    }
    #generateBtn:hover {
      background-color: #0056c0;
    }
    #sampleBtn {
      background-color: #888;
      color: white;
    }
    #sampleBtn:hover {
      background-color: #666;
    }
    #clearBtn {
      background-color: #999;
      color: white;
    }
    #clearBtn:hover {
      background-color: #777;
    }

    #error {
      display: none;
      background: #ffdddd;
      color: #aa0000;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    #result {
      display: none;
      background: white;
      padding: 20px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .skill-name {
      font-size: 22px;
      font-weight: bold;
      color: #333;
    }
    .skill-tagline {
      margin-top: 5px;
      font-style: italic;
      color: #555;
    }
    .skill-body {
      margin-top: 12px;
      line-height: 1.6;
    }

    .stats-box {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
    }
    .stat {
      flex: 1;
      text-align: center;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 8px 4px;
    }
    .stat-label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

  <h1>âš”ï¸ å¿…æ®ºæŠ€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆAIç‰ˆï¼‰</h1>

  <textarea id="intro" placeholder="ã‚ãªãŸã®è‡ªå·±ç´¹ä»‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>

  <button id="generateBtn">âš¡ å¿…æ®ºæŠ€ã‚’ç”Ÿæˆã™ã‚‹</button>
  <button id="sampleBtn">ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›</button>

  <div id="error"></div>

  <div id="result">
    <div class="skill-name" id="skillName"></div>
    <div class="skill-tagline" id="skillTagline"></div>
    <div class="skill-body" id="skillBody"></div>

    <!-- ã“ã“ãŒ ä½“åŠ›/æ”»æ’ƒåŠ›/é˜²å¾¡åŠ› ã®è¡¨ç¤ºéƒ¨åˆ† -->
    <div class="stats-box">
      <div class="stat">
        <span class="stat-label">ä½“åŠ›</span>
        <span class="stat-value" id="statHp">-</span>
      </div>
      <div class="stat">
        <span class="stat-label">æ”»æ’ƒåŠ›</span>
        <span class="stat-value" id="statAttack">-</span>
      </div>
      <div class="stat">
        <span class="stat-label">é˜²å¾¡åŠ›</span>
        <span class="stat-value" id="statDefense">-</span>
      </div>
    </div>
  </div>

  <button id="clearBtn">ğŸ§¹ ã‚¯ãƒªã‚¢</button>

  <script>
    // ===== ãƒ¦ãƒ‹ãƒ¼ã‚¯ã•ã‚¹ã‚³ã‚¢è¨ˆç®— =====
    function calcUniquenessScore(intro) {
      if (!intro) return 0;

      const text = intro.replace(/\s+/g, "");
      const length = text.length;
      if (length === 0) return 0;

      const uniqueChars = new Set(text).size;
      const charDiversity = uniqueChars / length; // 0ã€œ1 ãã‚‰ã„

      const hasLatin = /[A-Za-z]/.test(intro) ? 0.1 : 0;
      const hasDigits = /[0-9ï¼-ï¼™]/.test(intro) ? 0.05 : 0;
      const hasSymbols = /[!ï¼?ï¼Ÿ&ï¼ @]/.test(intro) ? 0.05 : 0;

      const lengthScore = Math.min(length / 200, 1); // 0ã€œ1

      let score =
        charDiversity * 0.5 +
        lengthScore * 0.3 +
        hasLatin +
        hasDigits +
        hasSymbols;

      score = Math.max(0, Math.min(score, 1));
      return score;
    }

    // ===== åˆè¨ˆå€¤ã‚’æ±ºã‚ã‚‹ï¼ˆå¹³å‡150ã€æœ€ä½10ï¼‰ =====
    function decideTotalFromUniqueness(intro) {
      const u = calcUniquenessScore(intro); // 0ã€œ1
      const minTotal = 10;   // æœ€ä½åˆè¨ˆå€¤
      const maxTotal = 290;  // 10ã¨290ã®ä¸­é–“ãŒ150ã«ãªã‚‹
      const total = Math.round(minTotal + u * (maxTotal - minTotal));
      return total;
    }

// åˆè¨ˆå€¤ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«3ã¤ã«åˆ†è§£ï¼ˆå„0ã€œ99ï¼‰
// ã•ã‚‰ã«ã€Œ80ä»¥ä¸Šã¯ãƒ¬ã‚¢ã€ã«ãªã‚‹ã‚ˆã†èª¿æ•´
function splitTotalRandom(total, parts = 3, minPer = 0, maxPer = 99) {
  const minTotal = parts * minPer;
  const maxTotal = parts * maxPer;
  let t = Math.max(minTotal, Math.min(total, maxTotal));

  // ã¾ãšç´ ã®ãƒ©ãƒ³ãƒ€ãƒ åˆ†è§£
  const result = new Array(parts).fill(minPer);
  let remaining = t - minTotal;

  for (let i = 0; i < parts; i++) {
    if (i === parts - 1) {
      const canAdd = maxPer - result[i];
      const add = Math.min(remaining, canAdd);
      result[i] += add;
      remaining -= add;
    } else {
      const canAdd = Math.min(remaining, maxPer - result[i]);
      const add = canAdd > 0 ? Math.floor(Math.random() * (canAdd + 1)) : 0;
      result[i] += add;
      remaining -= add;
    }
  }

  // ---- ã“ã“ã‹ã‚‰é«˜å¾—ç‚¹æŠ‘åˆ¶ãƒ­ã‚¸ãƒƒã‚¯ ----
  // 80ç‚¹ä»¥ä¸Šã¯å‡ºã«ããã™ã‚‹ï¼ˆç´„10%ã®ç¢ºç‡ã—ã‹è¨±å¯ã—ãªã„ï¼‰
  let excess = 0;
  for (let i = 0; i < parts; i++) {
    if (result[i] >= 80) {
      const allowHigh = Math.random() < 0.1; // 10% ã ã‘è¨±å¯

      if (!allowHigh) {
        excess += (result[i] - 79); // è¶…éåˆ†ã‚’å›å
        result[i] = 79;             // ä¸Šé™èª¿æ•´
      }
    }
  }

  // è¶…éåˆ†ã‚’ä»–ã¸å†é…åˆ†ï¼ˆåˆè¨ˆå€¤ã¯ç¶­æŒï¼‰
  while (excess > 0) {
    const idx = Math.floor(Math.random() * parts);
    if (result[idx] < 79) {
      result[idx]++;
      excess--;
    } else {
      // 79ç‚¹ãŒå¤šãã¦å›°ã£ãŸã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸‹ã’ã¦å¸å
      const j = Math.floor(Math.random() * parts);
      if (result[j] > 0) {
        excess--;
        result[j]--;
      }
    }
  }

  return result;
}

    // ===== è‡ªå·±ç´¹ä»‹æ–‡ã‹ã‚‰ ä½“åŠ›ãƒ»æ”»æ’ƒåŠ›ãƒ»é˜²å¾¡åŠ›ã‚’ç”Ÿæˆ =====
    function generateStatsFromIntro(intro) {
      const total = decideTotalFromUniqueness(intro);
      const [hp, attack, defense] = splitTotalRandom(total, 3, 0, 99);
      return { total, hp, attack, defense };
    }

    // ===== ã“ã“ã‹ã‚‰æ—¢å­˜ã®UIå‡¦ç† =====
    const introEl = document.getElementById("intro");
    const generateBtn = document.getElementById("generateBtn");
    const sampleBtn = document.getElementById("sampleBtn");
    const clearBtn = document.getElementById("clearBtn");

    const resultBox = document.getElementById("result");
    const errorBox = document.getElementById("error");

    const skillNameEl = document.getElementById("skillName");
    const skillTaglineEl = document.getElementById("skillTagline");
    const skillBodyEl = document.getElementById("skillBody");

    const statHpEl = document.getElementById("statHp");
    const statAttackEl = document.getElementById("statAttack");
    const statDefenseEl = document.getElementById("statDefense");

    // âš¡ å¿…æ®ºæŠ€ç”Ÿæˆãƒœã‚¿ãƒ³
    generateBtn.addEventListener("click", async () => {
      const text = introEl.value.trim();

      if (!text) {
        errorBox.textContent = "è‡ªå·±ç´¹ä»‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        errorBox.style.display = "block";
        resultBox.style.display = "none";
        return;
      }

      errorBox.style.display = "none";
      generateBtn.disabled = true;
      generateBtn.textContent = "ç”Ÿæˆä¸­â€¦";

      try {
        const res = await fetch("/api/generate-skill", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ intro: text })
        });

        if (!res.ok) throw new Error("Server Error");

        const data = await res.json();

        // å¿…æ®ºæŠ€ã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†
        skillNameEl.textContent = data.name;
        skillTaglineEl.textContent = data.tagline;
        skillBodyEl.textContent = data.description;

        // ğŸ§® ä½“åŠ›ãƒ»æ”»æ’ƒåŠ›ãƒ»é˜²å¾¡åŠ›ã‚’è¨ˆç®—ã—ã¦åæ˜ 
        const stats = generateStatsFromIntro(text);
        statHpEl.textContent = stats.hp;
        statAttackEl.textContent = stats.attack;
        statDefenseEl.textContent = stats.defense;

        resultBox.style.display = "block";

      } catch (err) {
        console.error(err);
        errorBox.textContent = "ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        errorBox.style.display = "block";
        resultBox.style.display = "none";
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = "âš¡ å¿…æ®ºæŠ€ã‚’ç”Ÿæˆã™ã‚‹";
      }
    });

    // ğŸ“ ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›
    sampleBtn.addEventListener("click", () => {
      introEl.value =
        "30ä»£ã®ä¼šç¤¾å“¡ã§ã™ã€‚ã‚³ãƒ„ã‚³ãƒ„ä½œæ¥­ã™ã‚‹ã®ãŒå¾—æ„ã§ã€ä¼‘æ—¥ã¯ã‚²ãƒ¼ãƒ ã¨æ–™ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚æ˜ã‚‹ã„æ€§æ ¼ã§ã€ã¿ã‚“ãªã‚’ç››ã‚Šä¸Šã’ã‚‹ã®ãŒå¥½ãã§ã™ã€‚";
    });

    // ğŸ§¹ ã‚¯ãƒªã‚¢
    clearBtn.addEventListener("click", () => {
      introEl.value = "";
      skillNameEl.textContent = "";
      skillTaglineEl.textContent = "";
      skillBodyEl.textContent = "";
      statHpEl.textContent = "-";
      statAttackEl.textContent = "-";
      statDefenseEl.textContent = "-";
      resultBox.style.display = "none";
      errorBox.style.display = "none";
    });
  </script>
</body>
</html>
