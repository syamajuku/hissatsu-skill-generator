<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¿…æ®ºæŠ€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #eef2f3;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
      max-width: 1100px;
      width: 100%;
    }
    .left-pane {
      width: 330px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .right-pane {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .field-label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    textarea,
    input[type="text"],
    input[type="file"] {
      width: 100%;
      margin-top: 5px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin-top: 10px;
    }
    #generateBtn { background: #ff7f50; color: #fff; }
    #sampleBtn { background: #888; color: #fff; }
    #clearBtn { background: #aaa; color: #fff; }
    #downloadBtn { background: #4caf50; color: #fff; }

    /* ã‚«ãƒ¼ãƒ‰å¤–æ ï¼ˆæ°´è‰²ï¼‰ */
    .card {
      width: 380px;
      padding: 12px;
      border-radius: 18px;
      background: linear-gradient(135deg, #d0ecff, #9fd6ff, #e4f6ff);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
      border: 4px solid #66b6ff;
      position: relative; /* è§’ãƒãƒƒã‚¸ã®åŸºæº–ã«ã™ã‚‹ */
    }
    /* ã‚«ãƒ¼ãƒ‰å†…å´ */
    .card-inner {
      border-radius: 14px;
      background: radial-gradient(
        circle at top,
        #ffffff 0%,
        #f4f6fb 40%,
        #f0f0f5 100%
      );
      padding: 16px;
      text-align: center;
    }

    /* è§’ãƒãƒƒã‚¸ï¼ˆã‚¸ãƒ£ãƒ³ã‚±ãƒ³ / ãƒˆãƒ©ãƒ³ãƒ—ï¼‰ */
    .corner-badge {
      position: absolute;
      top: 10px;
      width: 52px;
      height: 52px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #e5e7eb, #9ca3af);
      color: #111827;
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(248, 250, 252, 0.85);
      z-index: 3;
      font-size: 24px;
      user-select: none;
    }

    .janken-badge {
      left: 10px;
    }

    .trump-badge {
      right: 10px;
      font-size: 18px;
      flex-direction: column;
      padding-top: 4px;
      line-height: 1.1;
    }

    .trump-rank {
      font-size: 14px;
      font-weight: 700;
    }

    .trump-suit {
      font-size: 16px;
    }

    .card-title {
      font-size: 14px;
      font-weight: bold;
      letter-spacing: 2px;
      color: #555;
      margin-bottom: 4px;
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼‰ */
    .player-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }

    .avatar {
      width: 160px;
      height: 160px;
      border-radius: 12px;
      object-fit: cover;
      background: #ddd;
      margin: 0 auto 10px;
      display: block;
      border: 2px solid rgba(0, 0, 0, 0.15);
    }

    .skill-name {
      font-size: 22px;
      font-weight: bold;
      margin: 10px 0;
    }
    .tagline {
      font-size: 14px;
      color: #555;
      margin-bottom: 15px;
    }

    .job-area {
      margin-top: 10px;
      font-size: 14px;
      font-weight: bold;
    }
    .rarity-stars {
      color: gold;
      font-size: 18px;
      margin-left: 4px;
    }

    .status-area {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }
    .status-box {
      width: 30%;
      background: #fafafa;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    .status-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .status-value {
      font-size: 18px;
      font-weight: bold;
    }

    /* è‡ªå·±ç´¹ä»‹æ–‡è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .intro-area {
      margin-top: 12px;
      font-size: 13px;
      line-height: 1.4;
      text-align: left;
      color: #333;
      padding: 10px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #ddd;
      min-height: 40px;
      box-sizing: border-box;
      white-space: pre-wrap;
    }

    /* é€²æ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .progress-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .progress-box {
      background: #ffffff;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      min-width: 260px;
      text-align: center;
      font-size: 14px;
    }

    .progress-text {
      margin-bottom: 8px;
    }

    .progress-bar-bg {
      width: 260px;
      height: 10px;
      border-radius: 999px;
      background: #e0e0e0;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: #4fc3f7;
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- å·¦ãƒšã‚¤ãƒ³ï¼ˆå…¥åŠ›æ¬„ï¼‰ -->
    <div class="left-pane">
      <label class="field-label" for="playerNameInput">åå‰ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰</label>
      <input
        type="text"
        id="playerNameInput"
        maxlength="10"
        placeholder="ä¾‹ï¼šã‚·ãƒ³ãƒ¤"
      />

      <label class="field-label" for="intro">è‡ªå·±ç´¹ä»‹æ–‡ï¼ˆæœ€å¤§60æ–‡å­—ï¼‰</label>
      <textarea
        id="intro"
        maxlength="60"
        placeholder="ä¾‹ï¼šæ–™ç†ãŒå¾—æ„ã§ç©ã‚„ã‹ãªæ€§æ ¼ã§ã™ã€‚äººã‚’ç¬‘ã‚ã›ã‚‹ã®ãŒå¥½ãã§ã™ã€‚"
        rows="3"
      ></textarea>

      <label class="field-label" for="job">è·æ¥­ï¼ˆæœ€å¤§10æ–‡å­—ï¼‰</label>
      <input
        type="text"
        id="job"
        maxlength="10"
        placeholder="ä¾‹ï¼šãƒãƒªã‚¹ã‚¿ / ç ”ç©¶è€…"
      />

      <label class="field-label" for="photo">äººç‰©å†™çœŸï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒ–ç”¨ï¼‰</label>
      <input type="file" id="photo" accept="image/*" />

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼ˆè‡ªå‹•ã§æ›´æ–°ã•ã‚Œã‚‹ï¼‰ -->
      <img id="avatarPreview" class="avatar" style="display: none" />

      <button id="generateBtn">âš¡ ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹</button>
      <button id="sampleBtn">ğŸ“ ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›</button>
      <button id="clearBtn">ğŸ§¹ å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
      <button id="downloadBtn">ğŸ“¥ ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’PNGã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <!-- å³ãƒšã‚¤ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼‰ -->
    <div class="right-pane">
      <div class="card" id="cardRoot">
        <!-- å·¦ä¸Šï¼šã‚¸ãƒ£ãƒ³ã‚±ãƒ³ãƒãƒƒã‚¸ -->
        <div id="jankenBadge" class="corner-badge janken-badge" title="ã‚¸ãƒ£ãƒ³ã‚±ãƒ³">
          âœŠ
        </div>
        <!-- å³ä¸Šï¼šãƒˆãƒ©ãƒ³ãƒ—ãƒãƒƒã‚¸ -->
        <div id="trumpBadge" class="corner-badge trump-badge" title="ãƒˆãƒ©ãƒ³ãƒ—">
          <div class="trump-suit">â™¥</div>
          <div class="trump-rank">A</div>
        </div>

        <div class="card-inner">
          <div class="card-title">ã‚ãŸã‚‰ã—ã„ãƒãƒ¼ãƒ </div>
          <div class="player-name" id="cardPlayerName">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å</div>
          <img id="cardAvatar" class="avatar" />
          <div class="skill-name" id="skillName">å¿…æ®ºæŠ€å</div>
          <div class="tagline" id="tagline">ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼</div>

          <div class="job-area">
            <span id="jobLabel">è·æ¥­ï¼š</span>
            <span id="jobName"></span>
            <span id="rarityStars" class="rarity-stars"></span>
          </div>

          <!-- è‡ªå·±ç´¹ä»‹æ–‡ã®è¡¨ç¤ºé ˜åŸŸ -->
          <div class="intro-area" id="introArea"></div>

          <div class="status-area">
            <div class="status-box">
              <div class="status-title">ä½“åŠ›</div>
              <div class="status-value" id="hpVal">0</div>
            </div>
            <div class="status-box">
              <div class="status-title">æ”»æ’ƒåŠ›</div>
              <div class="status-value" id="atkVal">0</div>
            </div>
            <div class="status-box">
              <div class="status-title">é˜²å¾¡åŠ›</div>
              <div class="status-value" id="defVal">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é€²æ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="progressOverlay" class="progress-overlay" style="display:none;">
    <div class="progress-box">
      <div id="progressText" class="progress-text">ã‚«ãƒ¼ãƒ‰ç”Ÿæˆä¸­...</div>
      <div class="progress-bar-bg">
        <div id="progressBar" class="progress-bar-fill"></div>
      </div>
    </div>
  </div>

  <!-- html2canvasï¼ˆã‚«ãƒ¼ãƒ‰ã‚’ç”»åƒåŒ–ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // â˜… ã‚¹ã‚­ãƒ«åã‚’åŒºåˆ‡ã‚Šã®è‰¯ã„ä½ç½®ã§æœ€å¤§12æ–‡å­—ã«èª¿æ•´
    function truncateSkillName(raw, maxLen = 12) {
      if (!raw) return "";
      let name = raw.trim();
      if (name.length <= maxLen) return name;

      const chunk = name.slice(0, maxLen + 1);
      const breakPattern = /[ ã€€ãƒ»ï½¥\-ï¼¿â€ï¼:ï¼š]/g;
      let lastBreak = -1;
      let m;
      while ((m = breakPattern.exec(chunk)) !== null) {
        if (m.index <= maxLen) {
          lastBreak = m.index;
        }
      }
      return lastBreak > 0 ? name.slice(0, lastBreak) : name.slice(0, maxLen);
    }

    // â˜… è·æ¥­ã®ãƒ¬ã‚¢åº¦ï¼ˆæ˜Ÿ1ã€œ5ï¼‰
    function calcJobRarity(job) {
      if (!job) return 1;
      const lengthScore = Math.min(job.length, 10);
      const rareScore = Math.floor(Math.random() * lengthScore);

      if (rareScore >= 8) return 5;
      if (rareScore >= 6) return 4;
      if (rareScore >= 4) return 3;
      if (rareScore >= 2) return 2;
      return 1;
    }

    // â˜… åˆè¨ˆå€¤ã‚’3ã¤ã«åˆ†é…ï¼ˆ80ä»¥ä¸Šã¯ãƒ¬ã‚¢æ‰±ã„ï¼‰
    function splitTotalRandom(total, parts = 3, minPer = 0, maxPer = 99) {
      const minTotal = parts * minPer;
      const maxTotal = parts * maxPer;
      let t = Math.max(minTotal, Math.min(total, maxTotal));
      const result = new Array(parts).fill(minPer);
      let remaining = t - minTotal;

      for (let i = 0; i < parts; i++) {
        if (i === parts - 1) {
          const canAdd = maxPer - result[i];
          const add = Math.min(remaining, canAdd);
          result[i] += add;
          remaining -= add;
        } else {
          const canAdd = Math.min(remaining, maxPer - result[i]);
          const add = canAdd > 0 ? Math.floor(Math.random() * (canAdd + 1)) : 0;
          result[i] += add;
          remaining -= add;
        }
      }

      // 80ä»¥ä¸Š â†’ 10%ã ã‘è¨±å¯
      let excess = 0;
      for (let i = 0; i < parts; i++) {
        if (result[i] >= 80) {
          const allow = Math.random() < 0.1;
          if (!allow) {
            excess += result[i] - 79;
            result[i] = 79;
          }
        }
      }
      while (excess > 0) {
        const idx = Math.floor(Math.random() * parts);
        if (result[idx] < 79) {
          result[idx]++;
          excess--;
        } else {
          const j = Math.floor(Math.random() * parts);
          if (result[j] > 0) {
            result[j]--;
            excess--;
          }
        }
      }
      return result;
    }

    // â˜… æ–‡å­—åˆ—ãƒãƒƒã‚·ãƒ¥ï¼ˆã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼†ãƒˆãƒ©ãƒ³ãƒ—æ±ºå®šç”¨ï¼‰
    function hashString(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h * 31 + str.charCodeAt(i)) | 0;
      }
      return Math.abs(h);
    }

    // DOMå–å¾—
    const playerNameInputEl = document.getElementById("playerNameInput");
    const introEl = document.getElementById("intro");
    const jobEl = document.getElementById("job");
    const photoInput = document.getElementById("photo");
    const avatarPreview = document.getElementById("avatarPreview");

    const generateBtn = document.getElementById("generateBtn");
    const sampleBtn = document.getElementById("sampleBtn");
    const clearBtn = document.getElementById("clearBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    const cardRoot = document.getElementById("cardRoot");
    const cardAvatar = document.getElementById("cardAvatar");
    const cardPlayerName = document.getElementById("cardPlayerName");

    const skillNameEl = document.getElementById("skillName");
    const taglineEl = document.getElementById("tagline");
    const hpValEl = document.getElementById("hpVal");
    const atkValEl = document.getElementById("atkVal");
    const defValEl = document.getElementById("defVal");
    const jobNameEl = document.getElementById("jobName");
    const rarityStarsEl = document.getElementById("rarityStars");
    const introAreaEl = document.getElementById("introArea");

    const progressOverlay = document.getElementById("progressOverlay");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    // ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼ãƒˆãƒ©ãƒ³ãƒ—DOM
    const jankenBadgeEl = document.getElementById("jankenBadge");
    const trumpBadgeEl = document.getElementById("trumpBadge");

    function showProgress(percent, text) {
      if (!progressOverlay || !progressBar || !progressText) return;
      progressOverlay.style.display = "flex";
      progressBar.style.width = percent + "%";
      if (text) progressText.textContent = text;
    }

    function hideProgress() {
      if (!progressOverlay || !progressBar || !progressText) return;
      progressOverlay.style.display = "none";
      progressBar.style.width = "0%";
      progressText.textContent = "ã‚«ãƒ¼ãƒ‰ç”Ÿæˆä¸­...";
    }

    // ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼†ãƒˆãƒ©ãƒ³ãƒ—å€™è£œ
    const JANKEN_SET = [
      { label: "ã‚°ãƒ¼", emoji: "âœŠ" },
      { label: "ãƒãƒ§ã‚­", emoji: "âœŒï¸" },
      { label: "ãƒ‘ãƒ¼", emoji: "âœ‹" },
    ];

    const TRUMP_SUITS = [
      { label: "ãƒãƒ¼ãƒˆ", symbol: "â™¥", color: "#ef4444" },
      { label: "ãƒ€ã‚¤ãƒ¤", symbol: "â™¦", color: "#f97316" },
      { label: "ã‚¯ãƒ©ãƒ–", symbol: "â™£", color: "#22c55e" },
      { label: "ã‚¹ãƒšãƒ¼ãƒ‰", symbol: "â™ ", color: "#111827" },
    ];

    const TRUMP_RANKS = [
      "A", "2", "3", "4", "5", "6", "7",
      "8", "9", "10", "J", "Q", "K",
    ];

    let currentJanken = JANKEN_SET[0];
    let currentSuit = TRUMP_SUITS[0];
    let currentRank = TRUMP_RANKS[0];

    // å…¥åŠ›å†…å®¹ã‹ã‚‰ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼†ãƒˆãƒ©ãƒ³ãƒ—ã‚’æ±ºå®šã—è¡¨ç¤ºã™ã‚‹
    function updateBattleIcons(name, intro, job) {
      const base = (name || "") + "|" + (intro || "") + "|" + (job || "");
      const seed = hashString(base);

      const jIndex = seed % JANKEN_SET.length;
      const sIndex = Math.floor(seed / 7) % TRUMP_SUITS.length;
      const rIndex = Math.floor(seed / 13) % TRUMP_RANKS.length;

      currentJanken = JANKEN_SET[jIndex];
      currentSuit = TRUMP_SUITS[sIndex];
      currentRank = TRUMP_RANKS[rIndex];

      if (jankenBadgeEl) {
        jankenBadgeEl.textContent = currentJanken.emoji;
        jankenBadgeEl.title = `ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼š${currentJanken.label}`;
      }

      if (trumpBadgeEl) {
        const suitDiv = trumpBadgeEl.querySelector(".trump-suit");
        const rankDiv = trumpBadgeEl.querySelector(".trump-rank");
        if (suitDiv) {
          suitDiv.textContent = currentSuit.symbol;
          suitDiv.style.color = currentSuit.color;
        }
        if (rankDiv) {
          rankDiv.textContent = currentRank;
        }
        trumpBadgeEl.title = `${currentSuit.label}ã®${currentRank}`;
      }
    }

    // åˆæœŸè¡¨ç¤º
    updateBattleIcons("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å", "", "");

    // âš¡ ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
    generateBtn.addEventListener("click", async () => {
      const intro = introEl.value.trim();
      const job = jobEl.value.trim();
      const file = photoInput.files[0];
      const playerName = playerNameInputEl.value.trim();

      if (!intro) {
        alert("è‡ªå·±ç´¹ä»‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      generateBtn.disabled = true;
      const oldLabel = generateBtn.textContent;
      generateBtn.textContent = "ç”Ÿæˆä¸­â€¦";

      showProgress(0, "ã‚«ãƒ¼ãƒ‰ç”Ÿæˆã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...");

      let avatarProgressTimer = null;

      try {
        const tasks = [];

        // å¿…æ®ºæŠ€ç”Ÿæˆã‚¿ã‚¹ã‚¯
        const skillTask = (async () => {
          showProgress(5, "å¿…æ®ºæŠ€ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");

          const skillRes = await fetch("/api/generate-skill", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ intro }),
          });

          const skillData = await skillRes.json();

          if (!skillRes.ok) {
            throw new Error(skillData.error || "å¿…æ®ºæŠ€ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }

          const skillName = truncateSkillName(skillData.name || "", 12);
          skillNameEl.textContent = skillName;
          taglineEl.textContent = skillData.tagline;

          // åå‰
          cardPlayerName.textContent = playerName || "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å";

          // è·æ¥­
          jobNameEl.textContent = job || "(æœªè¨­å®š)";
          const rarity = calcJobRarity(job);
          rarityStarsEl.innerHTML = "â˜…".repeat(rarity);

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ
          const total = Math.floor(Math.random() * 141) + 10;
          const [hp, atk, def] = splitTotalRandom(total);
          hpValEl.textContent = hp;
          atkValEl.textContent = atk;
          defValEl.textContent = def;

          // è‡ªå·±ç´¹ä»‹æ–‡ã‚’ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤º
          introAreaEl.textContent = intro;

          // ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼†ãƒˆãƒ©ãƒ³ãƒ—æ›´æ–°
          updateBattleIcons(cardPlayerName.textContent, intro, job);

          showProgress(file ? 30 : 100, "ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");
        })();

        tasks.push(skillTask);

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç”Ÿæˆã‚¿ã‚¹ã‚¯
        if (file) {
          const avatarTask = (async () => {
            let current = 30;
            showProgress(current, "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");

            avatarProgressTimer = setInterval(() => {
              current += 0.9;
              if (current >= 90) {
                current = 90;
                clearInterval(avatarProgressTimer);
                avatarProgressTimer = null;
              }
              showProgress(current);
            }, 1000);

            const formData = new FormData();
            formData.append("photo", file);

            const avatarRes = await fetch("/api/generate-avatar", {
              method: "POST",
              body: formData,
            });

            let avatarData = {};
            try {
              avatarData = await avatarRes.json();
            } catch (e) {
              console.error("avatar json parse error:", e);
            }

            if (!avatarRes.ok) {
              console.error("avatar api error:", avatarData);
              alert(
                "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" +
                  (avatarData.error || `status: ${avatarRes.status}`)
              );
              return;
            }

            if (!avatarData.imageUrl) {
              alert("ç”»åƒURLãŒè¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸã€‚");
              return;
            }

            if (avatarProgressTimer) clearInterval(avatarProgressTimer);
            showProgress(100, "ã‚«ãƒ¼ãƒ‰ãŒå®Œæˆã—ã¾ã—ãŸï¼");

            avatarPreview.src = avatarData.imageUrl;
            avatarPreview.style.display = "block";
            cardAvatar.src = avatarData.imageUrl;
          })();

          tasks.push(avatarTask);
        }

        await Promise.all(tasks);

        if (!file) {
          showProgress(100, "ã‚«ãƒ¼ãƒ‰ãŒå®Œæˆã—ã¾ã—ãŸï¼");
        }

        setTimeout(() => hideProgress(), 500);

      } catch (err) {
        console.error(err);
        alert("ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        hideProgress();
      } finally {
        if (avatarProgressTimer) clearInterval(avatarProgressTimer);
        generateBtn.disabled = false;
        generateBtn.textContent = oldLabel;
      }
    });

    // ğŸ“ ã‚µãƒ³ãƒ—ãƒ«
    sampleBtn.addEventListener("click", () => {
      playerNameInputEl.value = "ã‚·ãƒ³ãƒ¤";
      introEl.value =
        "æ–™ç†ãŒå¾—æ„ã§ã€æ˜ã‚‹ãã¦ç¤¾äº¤çš„ã€‚äººã‚’ç¬‘ã‚ã›ã‚‹ã®ãŒå¥½ãã€‚";
      jobEl.value = "ãƒãƒªã‚¹ã‚¿";
      cardPlayerName.textContent = "ã‚·ãƒ³ãƒ¤";

      introAreaEl.textContent = introEl.value.trim();

      updateBattleIcons(
        cardPlayerName.textContent,
        introEl.value.trim(),
        jobEl.value.trim()
      );
    });

    // ğŸ§¹ ã‚¯ãƒªã‚¢
    clearBtn.addEventListener("click", () => {
      playerNameInputEl.value = "";
      introEl.value = "";
      jobEl.value = "";
      avatarPreview.style.display = "none";
      avatarPreview.removeAttribute("src");
      cardAvatar.removeAttribute("src");
      cardPlayerName.textContent = "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å";
      skillNameEl.textContent = "å¿…æ®ºæŠ€å";
      taglineEl.textContent = "ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼";
      jobNameEl.textContent = "";
      rarityStarsEl.textContent = "";
      hpValEl.textContent = "0";
      atkValEl.textContent = "0";
      defValEl.textContent = "0";
      introAreaEl.textContent = "";

      currentJanken = JANKEN_SET[0];
      currentSuit = TRUMP_SUITS[0];
      currentRank = TRUMP_RANKS[0];
      updateBattleIcons("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å", "", "");
    });

    // ğŸ“¥ ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’PNGã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    downloadBtn.addEventListener("click", async () => {
      try {
        const canvas = await html2canvas(cardRoot, {
          backgroundColor: null,
          scale: 2,
        });

        const dataUrl = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        const playerName = playerNameInputEl.value.trim() || "character";
        link.download = `card_${playerName}.png`;
        link.href = dataUrl;
        link.click();
      } catch (err) {
        console.error("download error:", err);
        alert("ã‚«ãƒ¼ãƒ‰ç”»åƒã®æ›¸ãå‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });
  </script>
</body>
</html>
